const STROKE_WIDTH=3;export default class Chart{width=640;height=360;constructor(e,t){this.data=t;const r=t.map(([e,t])=>e/t),f=Math.max(...r),u=Math.min(...r),a=d3.select(e),n=a.append("svg").attr("width","100%"),l=a.append("div").attr("role","tooltip");this.lines=[],this.chart=n.append("g"),this.text=n.append("g").attr("fill","white").attr("font-size","14");const d=this.chart.append("line").attr("x1",0).attr("x2",0).attr("y1",0).attr("y2",this.height).attr("stroke","white"),o=this.xScale=d3.scaleLinear().domain([1,t.length]).range([0,this.width]),h=d3.axisBottom(o),i=n.append("g").attr("aria-label","x-axis").attr("transform",`translate(0, ${this.height})`).call(h).node().getBBox();this.text.append("text").attr("x",this.width/2).attr("y",this.height-6).style("text-anchor","middle").text("segment number");const m=this.yScale=d3.scaleLinear().domain([u-5e4,f+1e4]).range([this.height,0]),s=d3.format(".3~s"),p=d3.axisLeft(m).tickFormat(s),c=n.append("g").attr("aria-label","y-axis").call(p).node().getBBox();this.text.append("text").attr("y","-6").style("transform","rotate(90deg)").style("text-anchor","start").text("bandwidth (bps)"),n.attr("viewBox",[Math.floor(c.x),0,i.width+c.width,this.height+i.height]);const g=this.chart.node();n.on("pointermove",e=>{if(e.pointerType==="touch")return;const[a]=d3.pointer(e,g),t=Math.round(o.invert(a)),n=Math.max(t-3,0),r=this.data.slice(n,n+3).map(([e,t],o)=>`<b>Segment ${o+n+1}:</b> ${s(e/t)}bps`).reverse(),c=this.lines.map(({title:e,points:n})=>`<b>${e}:</b> ${s(n[Math.max(t-1,0)])}bps`),i=o(t);d.attr("x1",i).attr("x2",i).attr("opacity",i>0?"0.4":"0"),l.node().innerHTML=r.join("<br />")+"<br />"+c.join("<br />")})}addKey(){const{lines:t,text:n}=this,e=n.append("g").attr("font-size","14"),o=(t,n,s)=>{const o=e.append("g");return o.append("line").attr("x1",-15).attr("x2",-5).attr("y1",18*n).attr("y2",18*n).attr("stroke",s).attr("stroke-width",2),o.append("text").attr("x",0).attr("y",18*n).attr("dominant-baseline","middle").attr("fill",s).text(t),o};t.forEach((n,s)=>{const{title:h,color:r,line:a,outline:i}=n,c=t.filter(e=>e!==n).map(({line:e})=>e),l=i.node(),o=e.append("g").style("cursor","pointer"),m=o.append("rect").attr("fill","rgba(0, 0, 0, 0.6)").attr("height",18).attr("x",-15).attr("y",18*s-18/2);o.append("line").attr("x1",-15).attr("x2",-5).attr("y1",18*s).attr("y2",18*s).attr("stroke",r).attr("stroke-width",STROKE_WIDTH),o.append("text").attr("x",0).attr("y",18*s).attr("dominant-baseline","middle").attr("fill",r).text(h),m.attr("width",o.node().getBBox().width);function d(){l.parentNode.appendChild(l),c.forEach(e=>e.style("opacity",.3)),a.style("stroke-width",STROKE_WIDTH+1)}o.on("mouseover",d),i.on("mouseover",d);function u(){a.style("stroke-width",STROKE_WIDTH),c.forEach(e=>e.style("opacity",1))}o.on("mouseout",u),i.on("mouseout",u),a.style("transition","all 0.3s 50ms"),i.style("cursor","pointer")});const s=Math.ceil(e.node().getBBox().width/2);e.style("transform",`translate(calc(50% - ${s}px), 20px)`)}addDots(){this.chart.selectAll("dot").data(this.data).enter().append("circle").attr("cx",(e,t)=>this.xScale(t+1)).attr("cy",([e,t])=>this.yScale(e/t)).attr("r",1.5).style("opacity","0.6").style("fill","white")}addLine({title:e,color:t,f:n}){const o=this.chart.append("path").datum(this.data).attr("aria-label",e).attr("stroke",t).attr("fill","none").attr("stroke-width",STROKE_WIDTH).style("pointer-events","none"),i=this.chart.append("path").datum(this.data).attr("aria-hidden","true").attr("stroke","transparent").attr("fill","none").attr("stroke-width",STROKE_WIDTH*5),s={title:e,color:t,f:n,line:o,outline:i,points:[]};return this.redrawLine(s),this.lines.push(s),s}redrawLine({f:e,line:t,outline:n,points:s}){const o=d3.line().curve(d3.curveCardinal).x((e,t)=>this.xScale(t+1)).y((t,n)=>this.yScale(s[n]=e(t)));n.attr("d",o),t.attr("d",o)}}