<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=alternate type=application/atom+xml title=redoPop href=https://redopop.com/feed.atom><link rel=apple-touch-icon-precomposed href=/apple-touch-icon.png><link rel=mask-icon href=/mask-icon.svg color=#3296f0><title>WebDAV as a virtual file server - redoPop</title><meta name=description content="Our team maintains a FUSE daemon which brings media files together from multiple storage systems and organizes them into directories based on metadata so editors can find them quickly. FUSE is facing a daunting future on macOS, so we&rsquo;ve been keeping an eye out for alternatives.
One of my wackier ideas was to build a virtual file server sharing the same tree structure over a protocol that enjoys direct macOS support: SMB, or less seriously: FTP or WebDAV."><meta name=twitter:card content="summary"><meta name=twitter:site content="@redoPop"><meta name=twitter:creator content="@redoPop"><meta name=twitter:title content="WebDAV as a virtual file server"><meta name=twitter:image content="https://redopop.com/cloud-1024.png"><meta property="og:type" content="article"><meta property="og:url" content="https://redopop.com/posts/webdav-file-server/"><meta property="og:site_name" content="redoPop"><meta property="og:title" content="WebDAV as a virtual file server"><meta property="og:image" content="https://redopop.com/cloud-1024.png"><style>:root{--popful-blue: #00b4ff;--darker-blue: #151a30;--rich-purple: #28165d;--popful-green: #50fa7b;--light-violet: #9c79ff;--soft-violet: #bd93f9;--gray-blue: #ccced0;--off-gray: #d8d8d2;--yellow: #faf500;--magenta: #ff4bda;--red: #ff5555;--pink: #ff79c6}html{height:100%;line-height:1.5}body{background:#000b16;color:var(--off-gray);font-family:-apple-system,BlinkMacSystemFont,segoe ui,Roboto,Arial,sans-serif;font-size:1.12rem;margin:0;-webkit-margin-bottom-collapse:separate}a,a:visited{color:var(--pink)}*:focus-visible{outline:3px solid var(--popful-green);outline-offset:.4ex}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:andale mono wt,andale mono,monospace;font-size:1em;line-height:1.3;padding:1px .4ex;box-decoration-break:clone;-webkit-box-decoration-break:clone}pre{overflow:auto}h1,h2,h3,h4,h5,h6{margin:1rem 0;line-height:1.3}h1{font-size:2.2rem}:is(dl,hr,ol,p,pre,ul){margin:1.6rem 0}:is(h2,h3,h4,h5,h6)+:is(dl,hr,ol,p,pre,ul){margin-top:0}:is(dl,hr,ol,p,pre,ul)+:is(h2,h3,h4,h5,h6){margin-top:3rem}hr{background-color:var(--light-violet);border:none;height:3px;margin-top:3rem}@media(min-width:42rem){body{font-size:1.2rem}h1{font-size:2.6rem}}.container{max-width:42rem;margin:0 auto;padding:0 20px}.Article:not(:last-child){border-bottom:3px solid var(--rich-purple);padding-bottom:1rem;margin:1rem 0}.Article__title{font-size:1.3rem;line-height:1.4;text-decoration:none}@media(min-width:30rem){.Article__title{font-size:1.6rem}}.Article__date{white-space:nowrap}.Clouds{width:100%;height:min(600px,100%);position:absolute;top:0;z-index:-1}.Footer{font-size:1rem;margin-top:6rem;padding:3rem 0 2.4rem}@media(min-width:600px){.Footer__container{display:flex;justify-content:space-between;align-items:center}}@media(max-width:600px){.Footer__social{margin-top:1rem}}.Header{margin:2rem auto 3rem}.Header__home,.Header__home:visited{color:var(--gray-blue);border-bottom:3px solid var(--popful-blue);padding-bottom:.6rem;text-decoration:none}.Header__pop{color:var(--popful-blue)}.Heading__link{text-decoration:none}@media(min-width:46rem){.Heading{display:flex;align-items:flex-start;margin-left:-2rem}.Heading__link{order:-1;flex:none;text-align:center;width:2rem;height:auto}}.Page{display:grid;grid-template-columns:100%;grid-template-rows:1fr auto;min-height:100%}.Social{display:flex}@media(min-width:600px){.Social{margin:0}}.Social svg{fill:var(--off-gray);width:3rem;height:3rem}.Social a{display:flex;margin:0 .4rem}.Social a:first-child{margin-left:-.2rem}.Social a:last-child{margin-right:-.2rem}</style><link rel=stylesheet href=https://redopop.com/extended.8da3cacd4c4a9a1fa29211aefd5aa814c17a6016f355c8cc93df3b8099a39cf9.css media=print onload="this.onload=null;this.media='all';"><noscript><link rel=stylesheet href=https://redopop.com/extended.8da3cacd4c4a9a1fa29211aefd5aa814c17a6016f355c8cc93df3b8099a39cf9.css></noscript></head><body class=Page><div><object aria-hidden=true tabindex=-1 type=image/svg+xml data=https://redopop.com/images/clouds.f62d85c12b6c3206e9724b2b53e0a2c1.min.svg class=Clouds></object><header class="container Header" role=banner><a href=https://redopop.com/ rel=home class=Header__home aria-label=Home>redo<span class=Header__pop>Pop</span></a></header><main class=h-entry itemscope itemtype=http://schema.org/Article aria-labelledby=title><div class=container><header><h1 class=p-name itemprop=name id=title>WebDAV as a virtual file server</h1><div style="display:flex;align-items:center;margin:1.2rem 0 4rem"><img src=https://redopop.com/images/poppet.60a86bdaa47168f352bf50cafd632b98.min.svg role=img width=48 height=48 style=margin-right:.8rem title="Author photo"><div style=font-size:1rem><div class=p-author itemprop=author>Joe Bartlett
<span style=opacity:.8>(he/him, they/them)</span></div><div style=color:var(--soft-violet)><time class=dt-published datetime=2020-02-22 itemprop=datePublished title=Published>Feb 22, 2020</time></div></div></div></header><div class=e-content itemprop=articleBody><p>Our team maintains a FUSE daemon which brings media files together from multiple storage systems and organizes them into directories based on metadata so editors can find them quickly. FUSE is <a href=https://developer.apple.com/support/kernel-extensions/ rel=external>facing a daunting future on macOS,</a> so we&rsquo;ve been keeping an eye out for alternatives.</p><p>One of my wackier ideas was to build a virtual file server sharing the same tree structure over a protocol that enjoys direct macOS support: SMB, or less seriously: FTP or WebDAV. I&rsquo;ve been tinkering in my free time to probe the viability of that idea.</p><p>Perhaps I&rsquo;ll share the more serious research into CIFS & SMB2 some other time. Before I knuckled down to that, I spent some time distracted by WebDAV. It&rsquo;s an infamously quirky protocol, but it&rsquo;s also a piece of web tech I&rsquo;d never paid much mind to. I had a surprising amount of fun playing with it.</p><h2 id=a-toy-webdav-server class=Heading>A toy WebDAV server
<a href=#a-toy-webdav-server class=Heading__link aria-hidden=true>#</a></h2><p>WebDAV uses HTTP to deliver file contents and XML payloads representing file & folder properties. It also extends HTTP with a handful of special verbs like <code>PROPFIND</code> which obtains the properties of a resource (whereas <code>GET</code> obtains the resource itself).</p><p>When a <code>PROPFIND</code> request is made to a directory (<em>a collection</em> in WebDAV parlance), the server doesn&rsquo;t just respond with the directory&rsquo;s properties but with the properties of its members too. This is represented as a multi-status response, as though <code>PROPFIND</code> requests had been made to each of those resources individually and their responses were being stitched together into one XML document.</p><p>To demonstrate that, here&rsquo;s a toy implementation written in Express â€“ a read-only WebDAV server that lists a single text file member of a root collection:</p><div class=highlight><pre class=chroma><code class=language-javascript data-lang=javascript><span class=kr>const</span> <span class=nx>express</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;express&#34;</span><span class=p>);</span>
<span class=kr>const</span> <span class=nx>xml</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;xmlbuilder&#34;</span><span class=p>);</span>

<span class=kr>const</span> <span class=nx>app</span> <span class=o>=</span> <span class=nx>express</span><span class=p>();</span>

<span class=c1>// Describes a mock file for our toy server
</span><span class=c1></span><span class=kr>const</span> <span class=nx>file</span> <span class=o>=</span> <span class=p>{</span>
  <span class=nx>path</span><span class=o>:</span> <span class=s2>&#34;/hello-world.txt&#34;</span><span class=p>,</span>
  <span class=nx>content</span><span class=o>:</span> <span class=s2>&#34;Hello World&#34;</span><span class=p>,</span>
  <span class=nx>ctime</span><span class=o>:</span> <span class=k>new</span> <span class=nb>Date</span><span class=p>(</span><span class=mi>2020</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>10</span><span class=p>),</span>
<span class=p>};</span>

<span class=c1>// Serve the file itself (standard get request)
</span><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=nx>file</span><span class=p>.</span><span class=nx>path</span><span class=p>,</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>res</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=nx>file</span><span class=p>.</span><span class=nx>content</span><span class=p>));</span>

<span class=c1>// Obtain properties for the root resource,
</span><span class=c1>// which is a collection containing our file
</span><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>propfind</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
  <span class=nx>res</span><span class=p>.</span><span class=nx>set</span><span class=p>(</span><span class=s2>&#34;Content-Type&#34;</span><span class=p>,</span> <span class=s2>&#34;application/xml&#34;</span><span class=p>);</span>

  <span class=c1>// Begin a multistatus XML document to represent
</span><span class=c1></span>  <span class=c1>// PROPFIND responses from multiple resources
</span><span class=c1></span>  <span class=kr>const</span> <span class=nx>doc</span> <span class=o>=</span> <span class=nx>xml</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span><span class=s2>&#34;D:multistatus&#34;</span><span class=p>).</span><span class=nx>att</span><span class=p>(</span><span class=s2>&#34;xmlns:D&#34;</span><span class=p>,</span> <span class=s2>&#34;DAV:&#34;</span><span class=p>);</span>

  <span class=c1>// Helper method for adding new a response to the doc
</span><span class=c1></span>  <span class=kr>const</span> <span class=nx>add</span> <span class=o>=</span> <span class=p>(</span><span class=nx>path</span><span class=p>,</span> <span class=nx>prop</span><span class=p>)</span> <span class=p>=&gt;</span>
    <span class=nx>doc</span><span class=p>.</span><span class=nx>ele</span><span class=p>({</span>
      <span class=s2>&#34;D:response&#34;</span><span class=o>:</span> <span class=p>{</span>
        <span class=s2>&#34;D:href&#34;</span><span class=o>:</span> <span class=p>{</span> <span class=s2>&#34;#text&#34;</span><span class=o>:</span> <span class=nx>path</span> <span class=p>},</span>
        <span class=s2>&#34;D:propstat&#34;</span><span class=o>:</span> <span class=p>{</span>
          <span class=s2>&#34;D:prop&#34;</span><span class=o>:</span> <span class=nx>prop</span><span class=p>,</span>
          <span class=s2>&#34;D:status&#34;</span><span class=o>:</span> <span class=s2>&#34;HTTP/1.1 200 OK&#34;</span><span class=p>,</span>
        <span class=p>},</span>
      <span class=p>},</span>
    <span class=p>});</span>

  <span class=c1>// Add a response for the root collection&#39;s properties
</span><span class=c1></span>  <span class=c1>// You can look up properties themselves in the WebDAV spec:
</span><span class=c1></span>  <span class=c1>// http://www.webdav.org/specs/rfc4918.html#dav.properties
</span><span class=c1></span>  <span class=nx>add</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>,</span> <span class=p>{</span>
    <span class=s2>&#34;D:creationdate&#34;</span><span class=o>:</span> <span class=nx>file</span><span class=p>.</span><span class=nx>ctime</span><span class=p>.</span><span class=nx>toUTCString</span><span class=p>(),</span>
    <span class=s2>&#34;D:getlastmodified&#34;</span><span class=o>:</span> <span class=nx>file</span><span class=p>.</span><span class=nx>ctime</span><span class=p>.</span><span class=nx>toUTCString</span><span class=p>(),</span>
    <span class=s2>&#34;D:resourcetype&#34;</span><span class=o>:</span> <span class=p>{</span> <span class=s2>&#34;D:collection&#34;</span><span class=o>:</span> <span class=s2>&#34;&#34;</span> <span class=p>},</span>
  <span class=p>});</span>

  <span class=c1>// Add a response for the file&#39;s properties
</span><span class=c1></span>  <span class=nx>add</span><span class=p>(</span><span class=nx>file</span><span class=p>.</span><span class=nx>path</span><span class=p>,</span> <span class=p>{</span>
    <span class=s2>&#34;D:getcontentlength&#34;</span><span class=o>:</span> <span class=nx>file</span><span class=p>.</span><span class=nx>content</span><span class=p>.</span><span class=nx>length</span><span class=p>,</span>
    <span class=s2>&#34;D:creationdate&#34;</span><span class=o>:</span> <span class=nx>file</span><span class=p>.</span><span class=nx>ctime</span><span class=p>.</span><span class=nx>toUTCString</span><span class=p>(),</span>
    <span class=s2>&#34;D:getlastmodified&#34;</span><span class=o>:</span> <span class=nx>file</span><span class=p>.</span><span class=nx>ctime</span><span class=p>.</span><span class=nx>toUTCString</span><span class=p>(),</span>
    <span class=s2>&#34;D:resourcetype&#34;</span><span class=o>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span> <span class=c1>// empty for non-collection resources
</span><span class=c1></span>  <span class=p>});</span>

  <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>207</span><span class=p>).</span><span class=nx>send</span><span class=p>(</span><span class=nx>doc</span><span class=p>.</span><span class=nx>end</span><span class=p>({</span> <span class=nx>pretty</span><span class=o>:</span> <span class=kc>true</span> <span class=p>}));</span>
<span class=p>});</span>

<span class=c1>// Respond to an OPTIONS request with the permitted verbs
</span><span class=c1>// for the root collection, and a DAV compliance class.
</span><span class=c1>// This tells clients that it&#39;s a WebDAV resource.
</span><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>options</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
  <span class=nx>res</span><span class=p>.</span><span class=nx>set</span><span class=p>({</span>
    <span class=nx>Allow</span><span class=o>:</span> <span class=s2>&#34;OPTIONS,PROPFIND&#34;</span><span class=p>,</span>
    <span class=nx>DAV</span><span class=o>:</span> <span class=s2>&#34;1&#34;</span><span class=p>,</span>
  <span class=p>});</span>
  <span class=nx>res</span><span class=p>.</span><span class=nx>send</span><span class=p>();</span>
<span class=p>});</span>

<span class=nx>app</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=mi>1900</span><span class=p>);</span>
</code></pre></div><p>Since it&rsquo;s a toy I&rsquo;ve left some things unimplemented, including authentication, but it&rsquo;s a complete working example that I&rsquo;ve tested in several WebDAV clients. (Authentication into a WebDAV server is assumed by macOS, so Finder will prompt you for a username and password if you connect to it. You can fill in any value.)</p><h2 id=0-1-infinity class=Heading>0, 1, infinity
<a href=#0-1-infinity class=Heading__link aria-hidden=true>#</a></h2><p>One of my favorite quirks of WebDAV (unimplemented in the toy above) is <a href=http://www.webdav.org/specs/rfc4918.html#HEADER_Depth rel=external>the depth header</a> â€“ a request header sent by clients to indicate how deeply they&rsquo;d like to inspect a collection if there are others nested within it. The depth header takes exactly three values:</p><ul><li><code>Depth: 0</code> â€“ give me details about this collection only</li><li><code>Depth: 1</code> â€“ give me details about this collection and its immediate members</li><li><code>Depth: infinity</code> â€“ give me details about the <em>entire tree</em> of resources that I can reach through this collection, down to the furthest leaf</li></ul><p>Evidently WebDAV wasn&rsquo;t designed with large trees in mind. ðŸ˜„</p><h2 id=extended-attributes class=Heading>Extended attributes
<a href=#extended-attributes class=Heading__link aria-hidden=true>#</a></h2><p>Our FUSE daemon also adds extended file attributes to associate files with custom metadata stored in a separate system and managed via an electron app. I was curious how we&rsquo;d accomplish that over WebDAV since its &ldquo;properties&rdquo; are limited to a few supported keys.</p><p>I found that macOS uses <a href=https://en.wikipedia.org/wiki/AppleSingle_and_AppleDouble_formats rel=external>AppleDouble Format files</a> to send extended attributes over WebDAV (AKA sidecar files, <code>._</code> files, or winky frogs). For each resource it encounters in a WebDAV collection, the macOS client sends a prospective GET request to an equivalently named <code>._</code> location and transparently ties that metadata to the original resource when extended attributes are read.</p><p>AppleDouble Format is relatively simple to produce and is covered by existing libraries in many languages, e.g. <a href=https://www.npmjs.com/package/xattr-file rel=external>xattr-file</a> in Node.</p><h2 id=chunked-reads class=Heading>Chunked reads
<a href=#chunked-reads class=Heading__link aria-hidden=true>#</a></h2><p>FUSE allows us to translate chunked reads into <a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Range rel=external>range requests</a> when reading over HTTP, which is important for buffering large files. With WebDAV we&rsquo;re at the mercy of the client to make that decision: the spec has no guarantees.</p><p>In my experiments, the macOS client made <em>some</em> range requests (e.g. for header information and probing for moov atoms at the back of MP4 files) but large sequential reads were translated to uncapped ranges, i.e. specifying a range-start but no range-end â€“ &ldquo;give me the the rest of the file.&rdquo; This puts buffering under more strain than adding content in controlled chunks, and video applications stall for several seconds when opening large files even within a local network.</p><p>I experimented with chunked transfer encoding (too slow, I suppose due to overhead from stitching files back together in an intermediary buffer) and forced Content-Range responses (which goes against the spec, so I didn&rsquo;t really expect it to work), but couldn&rsquo;t find a workaround.</p><p>I took this as my cue to stop monkeying about with WebDAV, but I was surprised how much fun I&rsquo;d been having. It&rsquo;s a unique application of HTTP and one I hadn&rsquo;t previously considered.</p></div><p style=margin-top:3rem><span style="border-top:3px solid var(--light-violet);padding-top:.6rem">Questions/corrections?
<a href=mailto:joe@redopop.com>Reach out!</a></span></p></div></main></div><footer class=Footer role=contentinfo><div class="container Footer__container"><span>redoPop is Joe Bartlett,<br>World Wide Web-slinger
&#9729;</span><div class=Footer__social><div class=Social><a href=https://github.com/redoPop rel="me external" title="redoPop on GitHub"><svg viewBox="0 0 100 100" aria-hidden="true"><use xlink:href="https://redopop.com/images/social.c9e36e50658d69fa75a2243f8458c1c7.min.svg#github"/></svg></a><a href=https://pinboard.in/u:redoPop rel="me external" title="redoPop on Pinboard"><svg viewBox="0 0 100 100" aria-hidden="true"><use xlink:href="https://redopop.com/images/social.c9e36e50658d69fa75a2243f8458c1c7.min.svg#pinboard"/></svg></a><a href=https://twitter.com/redoPop rel="me external" title="redoPop on Twitter"><svg viewBox="0 0 100 100" aria-hidden="true"><use xlink:href="https://redopop.com/images/social.c9e36e50658d69fa75a2243f8458c1c7.min.svg#twitter"/></svg></a></div></div></div></footer></body></html>