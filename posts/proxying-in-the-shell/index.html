<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=alternate type=application/atom+xml title=redoPop href=https://redopop.com/feed.atom><link rel=apple-touch-icon-precomposed href=/apple-touch-icon.png><link rel=mask-icon href=/mask-icon.svg color=#3296f0><title>Using Charles to override server-to-server API responses for Rails & Node development on macOS - redoPop</title><meta name=description content="A handy thing about microservice architectures is how easily you can inspect & override server-to-server API responses in local development. For example, updating your app for a planned-but-unimplemented API change.
Charles Proxy is particularly helpful here. We use Charles a lot in front-end development and debugging, so I&rsquo;ll assume you&rsquo;re already familiar with features like Breakpoints and Map Local to intercept and rewrite requests & responses. However, there are a couple of snags unique to the command line environment which can be a stumbling block when you&rsquo;re trying to apply the same approach to server-side development."><meta name=twitter:card content="summary"><meta name=twitter:site content="@redoPop"><meta name=twitter:creator content="@redoPop"><meta name=twitter:title content="Using Charles to override server-to-server API responses for Rails & Node development on macOS"><meta name=twitter:image content="https://redopop.com/cloud-1024.png"><meta property="og:type" content="article"><meta property="og:url" content="https://redopop.com/posts/proxying-in-the-shell/"><meta property="og:site_name" content="redoPop"><meta property="og:title" content="Using Charles to override server-to-server API responses for Rails & Node development on macOS"><meta property="og:image" content="https://redopop.com/cloud-1024.png"><style>:root{--popful-blue: #00b4ff;--darker-blue: #151a30;--rich-purple: #28165d;--popful-green: #50fa7b;--light-violet: #9c79ff;--soft-violet: #bd93f9;--gray-blue: #ccced0;--off-gray: #d8d8d2;--yellow: #faf500;--magenta: #ff4bda;--red: #ff5555;--pink: #ff79c6}html{height:100%;line-height:1.5}body{background:#000b16;color:var(--off-gray);font-family:-apple-system,BlinkMacSystemFont,segoe ui,Roboto,Arial,sans-serif;font-size:1.12rem;margin:0;-webkit-margin-bottom-collapse:separate}a,a:visited{color:var(--pink)}*:focus-visible{outline:3px solid var(--popful-green);outline-offset:.4ex}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:andale mono wt,andale mono,monospace;font-size:1em;line-height:1.3;padding:1px .4ex;box-decoration-break:clone;-webkit-box-decoration-break:clone}pre{overflow:auto}h1,h2,h3,h4,h5,h6{margin:1rem 0;line-height:1.3}h1{font-size:2.2rem}:is(dl,hr,ol,p,pre,ul){margin:1.6rem 0}:is(h2,h3,h4,h5,h6)+:is(dl,hr,ol,p,pre,ul){margin-top:0}:is(dl,hr,ol,p,pre,ul)+:is(h2,h3,h4,h5,h6){margin-top:3rem}hr{background-color:var(--light-violet);border:none;height:3px;margin-top:3rem}@media(min-width:42rem){body{font-size:1.2rem}h1{font-size:2.6rem}}.container{max-width:42rem;margin:0 auto;padding:0 20px}.Article:not(:last-child){border-bottom:3px solid var(--rich-purple);padding-bottom:1rem;margin:1rem 0}.Article__title{font-size:1.3rem;line-height:1.4;text-decoration:none}@media(min-width:30rem){.Article__title{font-size:1.6rem}}.Article__date{white-space:nowrap}.Clouds{width:100%;height:min(600px,100%);position:absolute;top:0;z-index:-1}.Footer{font-size:1rem;margin-top:6rem;padding:3rem 0 2.4rem}@media(min-width:600px){.Footer__container{display:flex;justify-content:space-between;align-items:center}}@media(max-width:600px){.Footer__social{margin-top:1rem}}.Header{margin:2rem auto 3rem}.Header__home,.Header__home:visited{color:var(--gray-blue);border-bottom:3px solid var(--popful-blue);padding-bottom:.6rem;text-decoration:none}.Header__pop{color:var(--popful-blue)}.Heading__link{text-decoration:none}@media(min-width:46rem){.Heading{display:flex;align-items:flex-start;margin-left:-2rem}.Heading__link{order:-1;flex:none;text-align:center;width:2rem;height:auto}}.Page{display:grid;grid-template-columns:100%;grid-template-rows:1fr auto;min-height:100%}.Social{display:flex}@media(min-width:600px){.Social{margin:0}}.Social svg{fill:var(--off-gray);width:3rem;height:3rem}.Social a{display:flex;margin:0 .4rem}.Social a:first-child{margin-left:-.2rem}.Social a:last-child{margin-right:-.2rem}</style><link rel=stylesheet href=https://redopop.com/extended.8da3cacd4c4a9a1fa29211aefd5aa814c17a6016f355c8cc93df3b8099a39cf9.css media=print onload="this.onload=null;this.media='all';"><noscript><link rel=stylesheet href=https://redopop.com/extended.8da3cacd4c4a9a1fa29211aefd5aa814c17a6016f355c8cc93df3b8099a39cf9.css></noscript></head><body class=Page><div><object aria-hidden=true tabindex=-1 type=image/svg+xml data=https://redopop.com/images/clouds.f62d85c12b6c3206e9724b2b53e0a2c1.min.svg class=Clouds></object><header class="container Header" role=banner><a href=https://redopop.com/ rel=home class=Header__home aria-label=Home>redo<span class=Header__pop>Pop</span></a></header><main class=h-entry itemscope itemtype=http://schema.org/Article aria-labelledby=title><div class=container><header><h1 class=p-name itemprop=name id=title>Using Charles to override server-to-server API responses for Rails & Node development on macOS</h1><div style="display:flex;align-items:center;margin:1.2rem 0 4rem"><img src=https://redopop.com/images/poppet.60a86bdaa47168f352bf50cafd632b98.min.svg role=img width=48 height=48 style=margin-right:.8rem title="Author photo"><div style=font-size:1rem><div class=p-author itemprop=author>Joe Bartlett
<span style=opacity:.8>(he/him, they/them)</span></div><div style=color:var(--soft-violet)><time class=dt-published datetime=2020-01-03 itemprop=datePublished title=Published>Jan 3, 2020</time></div></div></div></header><div class=e-content itemprop=articleBody><p>A handy thing about microservice architectures is how easily you can inspect & override server-to-server API responses in local development. For example, updating your app for a planned-but-unimplemented API change.</p><p><a href=https://www.charlesproxy.com/ rel=external>Charles Proxy</a> is particularly helpful here. We use Charles a lot in front-end development and debugging, so I&rsquo;ll assume you&rsquo;re already familiar with features like <a href=https://www.charlesproxy.com/documentation/proxying/breakpoints/ rel=external>Breakpoints</a> and <a href=https://www.charlesproxy.com/documentation/tools/map-local/ rel=external>Map Local</a> to intercept and rewrite requests & responses. However, there are a couple of snags unique to the command line environment which can be a stumbling block when you&rsquo;re trying to apply the same approach to server-side development.</p><p>Don&rsquo;t be put off! It&rsquo;s easy when you know how. ðŸ˜„</p><h2 id=using-an-http-proxy-on-the-command-line class=Heading>Using an HTTP proxy on the command line
<a href=#using-an-http-proxy-on-the-command-line class=Heading__link aria-hidden=true>#</a></h2><p>macOS proxy settings (set through Charles or via Network Preferences) are automatically applied to GUI applications â€“ including most browsers â€“ but they don&rsquo;t extend to the command line.</p><p>By convention that&rsquo;s remedied via the <code>http_proxy</code>/<code>https_proxy</code> environment variables, which can point to the Charles HTTP Proxy in familiar <code>scheme://[userinfo@]host[:port]</code> URI syntax, i.e. for most of us:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=nb>export</span> <span class=nv>https_proxy</span><span class=o>=</span><span class=s2>&#34;http://127.0.0.1:8888&#34;</span>
</code></pre></div><p>Applications that honor these variables then use the specified proxy when making HTTP/HTTPS requests. If you find it tedious to configure each time, Derek Morgan had the idea of <a href=https://dmorgan.info/posts/mac-network-proxy-terminal/ rel=external>using scutil output to set the variable automatically based on macOS proxy settings.</a> I don&rsquo;t do this, in part because of a problem Node makes:</p><h3 id=nodes-proxy-got-cha class=Heading>Node&rsquo;s proxy Got-cha
<a href=#nodes-proxy-got-cha class=Heading__link aria-hidden=true>#</a></h3><p>Some popular tools & libraries <a href=https://github.com/sindresorhus/got/issues/560 rel=external>like Node & Got</a> don&rsquo;t honor the conventional <code>http_proxy</code>/<code>https_proxy</code> environment variables.</p><p>For Node, the <a href=https://www.npmjs.com/package/global-agent rel=external>global-agent</a> package provides the same functionality, hooking into Node&rsquo;s <a href=https://nodejs.org/api/http.html#http_http_globalagent rel=external><code>globalAgent</code></a> configurations to add proxy support. It requires a little extra setup and has its own environment variables, <a href=https://www.npmjs.com/package/global-agent#setup-proxy-using-global-agentbootstrap rel=external>all covered by its readme.</a></p><p>For older Node versions (&lt; 12) <a href=https://github.com/np-maintain/global-tunnel rel=external>global-tunnel</a> serves a similar purpose.</p><h2 id=using-self-signed-certificates-on-the-command-line class=Heading>Using self-signed certificates on the command line
<a href=#using-self-signed-certificates-on-the-command-line class=Heading__link aria-hidden=true>#</a></h2><p>Command line applications also don&rsquo;t know about the certificates installed & trusted in the macOS System Keychain. They need to be configured into awareness of <a href=https://www.charlesproxy.com/documentation/proxying/ssl-proxying/ rel=external>the Charles root certificate,</a> otherwise proxied HTTPS requests will fail.</p><p>Ruby uses OpenSSL, which has an environment variable <code>SSL_CERT_FILE</code> for this purpose. That variable can point to the exported Charles root certificate <em>(Help > SSL Proxying > Save Charles Root Certificateâ€¦)</em> when starting Rails:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>env <span class=nv>SSL_CERT_FILE</span><span class=o>=</span><span class=s2>&#34;/path/to/cert.pem&#34;</span> rails s
</code></pre></div><p>Be aware: this configuration <em>replaces</em> the OpenSSL default, which will be a problem if the application makes HTTPS requests to hosts outside of Charles' configured SSL Proxying locations. This hasn&rsquo;t been an issue for me, but it&rsquo;s possible to <a href=https://www.jvt.me/posts/2019/12/04/openssl-certs-dir-setup/ rel=external>configure a directory of multiple certificates</a> to mix the default cert in.</p><p>Node makes this a little easier with an environment variable that&rsquo;s specifically designed to take <em>additional</em> certificates instead of an override:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>env <span class=nv>NODE_EXTRA_CA_CERTS</span><span class=o>=</span><span class=s2>&#34;/path/to/cert.pem&#34;</span> npm start
</code></pre></div><p>With these configurations in place, we can treat microservice APIs in Node & Rails just like we would in client applications. It&rsquo;s a handy tool for debugging and rapid development.</p></div><p style=margin-top:3rem><span style="border-top:3px solid var(--light-violet);padding-top:.6rem">Questions/corrections?
<a href=mailto:joe@redopop.com>Reach out!</a></span></p></div></main></div><footer class=Footer role=contentinfo><div class="container Footer__container"><span>redoPop is Joe Bartlett,<br>World Wide Web-slinger
&#9729;</span><div class=Footer__social><div class=Social><a href=https://github.com/redoPop rel="me external" title="redoPop on GitHub"><svg viewBox="0 0 100 100" aria-hidden="true"><use xlink:href="https://redopop.com/images/social.c9e36e50658d69fa75a2243f8458c1c7.min.svg#github"/></svg></a><a href=https://pinboard.in/u:redoPop rel="me external" title="redoPop on Pinboard"><svg viewBox="0 0 100 100" aria-hidden="true"><use xlink:href="https://redopop.com/images/social.c9e36e50658d69fa75a2243f8458c1c7.min.svg#pinboard"/></svg></a><a href=https://twitter.com/redoPop rel="me external" title="redoPop on Twitter"><svg viewBox="0 0 100 100" aria-hidden="true"><use xlink:href="https://redopop.com/images/social.c9e36e50658d69fa75a2243f8458c1c7.min.svg#twitter"/></svg></a></div></div></div></footer></body></html>